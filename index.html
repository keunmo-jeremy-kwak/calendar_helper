<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>✩ Google Calendar 등록 Helper</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      margin: 40px auto;
      text-align: center;
    }
    input, select, button {
      padding: 8px;
      margin: 6px;
      width: 90%;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2>🗓 Google Calendar 등록 Helper</h2>
  <div id="signin-area">
    <button id="login-btn" disabled>🔐 Google 로그인</button>
  </div>
  <div id="form-area" style="display:none;">
    <p><strong>환영합니다, <span id="username">...</span> 님!</strong></p>
    <select id="calendar-list"></select>
    <input type="text" id="title" placeholder="일정 제목">
    <input type="date" id="date">
    <select id="startTime"></select>
    <select id="endTime"></select>
    <button onclick="addEvent()">✅ 일정 추가</button>
  </div>

  <script>
    const CLIENT_ID = '106953701963-fpu3ouqhblfadj81geaep55apbi6ghk6.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBNQTPJC_FoqKKCwO0QHxyzPkdVWuTGyr0';
    const DISCOVERY_DOCS = [
      'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest',
      'https://people.googleapis.com/$discovery/rest?version=v1'
    ];
    const SCOPES = 'openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/userinfo.profile';

    let tokenClient;
    let gapiInited = false;

    const gapiLoaded = () => {
      gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
        gapiInited = true;
        const savedToken = localStorage.getItem('gToken');
        if (savedToken) {
          gapi.client.setToken(JSON.parse(savedToken));
          try {
            await onLoginSuccess();
          } catch (e) {
            localStorage.removeItem('gToken');
            document.getElementById("login-btn").disabled = false;
          }
        } else {
          document.getElementById("login-btn").disabled = false;
        }
      });
    };

    const gisLoaded = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            gapi.client.setToken(tokenResponse);
            localStorage.setItem('gToken', JSON.stringify(tokenResponse));
            await onLoginSuccess();
          } else {
            alert('🚨 로그인에 실패했습니다.');
          }
        }
      });

      document.getElementById("login-btn").addEventListener("click", () => {
        tokenClient.requestAccessToken({ prompt: 'consent' });
      });
    };

    async function onLoginSuccess() {
      const userInfo = await gapi.client.people.people.get({
        resourceName: 'people/me',
        personFields: 'names,emailAddresses'
      });
      const name = userInfo.result.names?.[0]?.displayName;
      const id = userInfo.result.resourceName?.split('/')[1];
      const email = userInfo.result.emailAddresses?.[0]?.value;
      const display = name || id || email || "Google 사용자";

      document.getElementById("username").textContent = display;

      const res = await gapi.client.calendar.calendarList.list();
      const select = document.getElementById("calendar-list");
      select.innerHTML = '';
      res.result.items.forEach(cal => {
        const opt = document.createElement("option");
        opt.value = cal.id;
        opt.textContent = cal.summary;
        select.appendChild(opt);
      });

      document.getElementById("signin-area").style.display = "none";
      document.getElementById("form-area").style.display = "block";
    }

    async function addEvent() {
      const title = document.getElementById("title").value;
      const date = document.getElementById("date").value;
      const startTime = document.getElementById("startTime").value;
      const endTime = document.getElementById("endTime").value;
      const calendarId = document.getElementById("calendar-list").value;

      const start = new Date(`${date}T${startTime}`);
      const end = new Date(`${date}T${endTime}`);

      const event = {
        summary: title,
        start: { dateTime: start.toISOString(), timeZone: 'Asia/Seoul' },
        end: { dateTime: end.toISOString(), timeZone: 'Asia/Seoul' }
      };

      try {
        await gapi.client.calendar.events.insert({ calendarId, resource: event });
        alert("✅ 일정이 등록되었습니다!");
        resetForm();
      } catch (err) {
        alert("⚠️ 오류: " + err.message);
      }
    }

    function resetForm() {
      document.getElementById("title").value = "";
      document.getElementById("date").value = "";
      document.getElementById("startTime").selectedIndex = 0;
      document.getElementById("endTime").selectedIndex = 0;
    }

    function createTimeOptions() {
      const start = document.getElementById("startTime");
      const end = document.getElementById("endTime");
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 10) {
          const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:00`;
          const label = timeStr.slice(0, 5);

          [start, end].forEach(select => {
            const opt = document.createElement("option");
            opt.value = timeStr;
            opt.textContent = label;
            select.appendChild(opt);
          });
        }
      }
    }

    window.onload = createTimeOptions;
  </script>

  <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
